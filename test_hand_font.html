<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•"æ‰‹"å­—å­—ä½“æ˜¾ç¤º</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div style="padding: 20px; font-size: 24px;">
        <h2>"æ‰‹"å­—åœ¨ä¸åŒå­—ä½“ä¸­çš„æ˜¾ç¤ºæ•ˆæœï¼š</h2>
        
        <div style="margin: 20px 0;">
            <strong>FangZhengOracleå­—ä½“ï¼š</strong>
            <span style="font-family: 'FangZhengOracle', serif; font-size: 48px; color: red;">æ‰‹</span>
        </div>
        
        <div style="margin: 20px 0;">
            <strong>HYChenTiJiaGuWenå­—ä½“ï¼š</strong>
            <span style="font-family: 'HYChenTiJiaGuWen', serif; font-size: 48px; color: blue;">æ‰‹</span>
        </div>
        
        <div style="margin: 20px 0;">
            <strong>OeasyOracleå­—ä½“ï¼š</strong>
            <span style="font-family: 'OeasyOracle', serif; font-size: 48px; color: green;">æ‰‹</span>
        </div>
        
        <div style="margin: 20px 0;">
            <strong>ZhongYanYuanå­—ä½“ï¼š</strong>
            <span style="font-family: 'ZhongYanYuan', serif; font-size: 48px; color: purple;">æ‰‹</span>
        </div>
        
        <div style="margin: 20px 0;">
            <strong>ç³»ç»Ÿé»˜è®¤å­—ä½“ï¼š</strong>
            <span style="font-family: serif; font-size: 48px; color: black;">æ‰‹</span>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="testFontDetection()">æµ‹è¯•å­—ä½“æ£€æµ‹é€»è¾‘</button>
            <div id="result" style="margin-top: 10px; padding: 10px; background: #f0f0f0;"></div>
        </div>
    </div>
    
    <script>
        // ä»app.jsä¸­å¤åˆ¶å¿…è¦çš„å­—ä½“æ£€æµ‹ä»£ç 
        const FONT_CONFIG = {
            primary: 'FangZhengOracle',
            secondary: 'HYChenTiJiaGuWen',
            tertiary: 'ZhongYanYuan',
            quaternary: 'OeasyOracle'
        };
        
        class FontLoader {
            constructor() {
                this.loadedFonts = new Set();
            }
            
            async loadFont(fontName) {
                try {
                    if (this.loadedFonts.has(fontName)) {
                        return true;
                    }
                    
                    await document.fonts.ready;
                    const fontSpec = `20px ${fontName}`;
                    if (document.fonts.check(fontSpec)) {
                        this.loadedFonts.add(fontName);
                        console.log(`å­—ä½“ ${fontName} åŠ è½½æˆåŠŸ`);
                        return true;
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            }
            
            getFontPriority() {
                return [FONT_CONFIG.primary, FONT_CONFIG.secondary, FONT_CONFIG.tertiary, FONT_CONFIG.quaternary];
            }
            
            async getCharacterScore(character, fontName) {
                console.log(`  ğŸ“Š å¼€å§‹è®¡ç®—å­—ä½“ ${fontName} å¯¹å­—ç¬¦ '${character}' çš„é€‚é…åˆ†æ•°`);
                
                if (!await this.loadFont(fontName)) {
                    console.log(`  âŒ å­—ä½“ ${fontName} æœªåŠ è½½ï¼Œè¿”å›åˆ†æ•° 0`);
                    return 0;
                }
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                
                // ä½¿ç”¨ç›®æ ‡å­—ä½“ç»˜åˆ¶å­—ç¬¦
                ctx.clearRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 200, 200);
                ctx.font = `72px "${fontName}"`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'black';
                ctx.fillText(character, 100, 100);
                
                const targetImageData = ctx.getImageData(0, 0, 200, 200);
                
                // ä½¿ç”¨é»˜è®¤å­—ä½“ç»˜åˆ¶å­—ç¬¦
                ctx.clearRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 200, 200);
                ctx.font = `72px serif`;
                ctx.fillStyle = 'black';
                ctx.fillText(character, 100, 100);
                
                const fallbackImageData = ctx.getImageData(0, 0, 200, 200);
                
                const targetData = targetImageData.data;
                const fallbackData = fallbackImageData.data;
                
                let differences = 0;
                let totalPixels = 0;
                
                for (let i = 0; i < targetData.length; i += 4) {
                    const targetAlpha = targetData[i + 3];
                    const fallbackAlpha = fallbackData[i + 3];
                    
                    if (targetAlpha > 0 || fallbackAlpha > 0) {
                        totalPixels++;
                        
                        const targetR = targetData[i];
                        const targetG = targetData[i + 1];
                        const targetB = targetData[i + 2];
                        
                        const fallbackR = fallbackData[i];
                        const fallbackG = fallbackData[i + 1];
                        const fallbackB = fallbackData[i + 2];
                        
                        const colorDiff = Math.abs(targetR - fallbackR) + 
                                        Math.abs(targetG - fallbackG) + 
                                        Math.abs(targetB - fallbackB) + 
                                        Math.abs(targetAlpha - fallbackAlpha);
                        
                        if (colorDiff > 10) {
                            differences++;
                        }
                    }
                }
                
                const score = totalPixels > 0 ? (differences / totalPixels) * 100 : 0;
                console.log(`  ğŸ“ˆ åƒç´ åˆ†æç»“æœ: æ€»åƒç´ =${totalPixels}, å·®å¼‚åƒç´ =${differences}, åˆ†æ•°=${score.toFixed(2)}%`);
                
                return score;
            }
            
            async getAvailableFontForCharacter(character) {
                const fonts = this.getFontPriority();
                
                console.log(`\n=== å¼€å§‹ä¸ºå­—ç¬¦ '${character}' æ£€æµ‹å­—ä½“ ===`);
                console.log('å­—ä½“ä¼˜å…ˆçº§é¡ºåº:', fonts);
                
                for (let i = 0; i < fonts.length; i++) {
                    const font = fonts[i];
                    console.log(`\næ£€æµ‹å­—ä½“ ${i + 1}/${fonts.length}: ${font}`);
                    
                    const fontLoaded = await this.loadFont(font);
                    console.log(`å­—ä½“ ${font} åŠ è½½çŠ¶æ€:`, fontLoaded);
                    
                    if (!fontLoaded) {
                        console.log(`å­—ä½“ ${font} åŠ è½½å¤±è´¥ï¼Œè·³è¿‡`);
                        continue;
                    }
                    
                    const score = await this.getCharacterScore(character, font);
                    console.log(`å­—ä½“ ${font} å¯¹å­—ç¬¦ '${character}' çš„é€‚é…åˆ†æ•°: ${score.toFixed(2)}%`);
                    
                    const threshold = 5;
                    
                    if (character === 'æ‰‹' && font === 'FangZhengOracle' && score < threshold) {
                        console.log(`ğŸ¯ "æ‰‹"å­—ç‰¹æ®Šå¤„ç†ï¼šFangZhengOracleå­—ä½“ä¸åŒ…å«è¯¥å­—ç¬¦ï¼Œè·³è¿‡`);
                        continue;
                    }
                    
                    if (score > threshold) {
                        console.log(`âœ… é€‰æ‹©å­—ä½“: ${font} (åˆ†æ•°: ${score.toFixed(2)}%)`);
                        console.log(`=== å­—ä½“æ£€æµ‹å®Œæˆ ===\n`);
                        return font;
                    } else {
                        console.log(`âŒ å­—ä½“ ${font} åˆ†æ•°è¿‡ä½ (${score.toFixed(2)}%)ï¼Œç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ªå­—ä½“`);
                    }
                }
                
                console.log(`\nâš ï¸ æ‰€æœ‰ç”²éª¨æ–‡å­—ä½“éƒ½ä¸é€‚åˆå­—ç¬¦ '${character}'ï¼Œä½¿ç”¨é»˜è®¤å­—ä½“ serif`);
                console.log(`=== å­—ä½“æ£€æµ‹å®Œæˆ ===\n`);
                return 'serif';
            }
        }
        
        async function testFontDetection() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•å­—ä½“æ£€æµ‹...';
            
            const fontLoader = new FontLoader();
            const result = await fontLoader.getAvailableFontForCharacter('æ‰‹');
            
            resultDiv.innerHTML = `<strong>æ£€æµ‹ç»“æœï¼š</strong>"æ‰‹"å­—åº”ä½¿ç”¨å­—ä½“ï¼š<span style="color: red;">${result}</span>`;
        }
    </script>
</body>
</html>