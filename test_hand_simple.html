<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>测试手字字体</title>
    <style>
        @font-face {
            font-family: 'FangZhengOracle';
            src: url('fonts/FangZhengOracle.ttf') format('truetype');
        }
        @font-face {
            font-family: 'HYChenTiJiaGuWen';
            src: url('fonts/HYChenTiJiaGuWen.ttf') format('truetype');
        }
        @font-face {
            font-family: 'OeasyOracle';
            src: url('fonts/OeasyOracle.ttf') format('truetype');
        }
        @font-face {
            font-family: 'ZhongYanYuan';
            src: url('fonts/ZhongYanYuan.ttf') format('truetype');
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .char-display {
            font-size: 72px;
            margin: 10px;
            display: inline-block;
            border: 2px solid #ddd;
            padding: 20px;
            text-align: center;
            min-width: 120px;
        }
        
        .font-name {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        #result {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <h1>"手"字字体测试</h1>
    
    <div class="test-container">
        <h3>各字体显示效果：</h3>
        <div class="char-display" style="font-family: 'HYChenTiJiaGuWen', serif;">
            手
            <div class="font-name">HYChenTiJiaGuWen</div>
        </div>
        <div class="char-display" style="font-family: 'OeasyOracle', serif;">
            手
            <div class="font-name">OeasyOracle</div>
        </div>
        <div class="char-display" style="font-family: 'FangZhengOracle', serif;">
            手
            <div class="font-name">FangZhengOracle</div>
        </div>
        <div class="char-display" style="font-family: 'ZhongYanYuan', serif;">
            手
            <div class="font-name">ZhongYanYuan</div>
        </div>
        <div class="char-display" style="font-family: serif;">
            手
            <div class="font-name">默认字体 (serif)</div>
        </div>
    </div>
    
    <div class="test-container">
        <button onclick="testFontDetection()">测试字体检测算法</button>
        <div id="result">点击按钮开始测试...</div>
    </div>
    
    <script>
        // 字体配置
        const FONT_CONFIG = {
            primary: 'HYChenTiJiaGuWen',
            secondary: 'OeasyOracle', 
            tertiary: 'FangZhengOracle',
            quaternary: 'ZhongYanYuan'
        };
        
        class FontLoader {
            constructor() {
                this.loadedFonts = new Set();
            }
            
            async loadFont(fontName) {
                try {
                    if (this.loadedFonts.has(fontName)) {
                        return true;
                    }
                    
                    await document.fonts.ready;
                    const fontSpec = `20px ${fontName}`;
                    if (document.fonts.check(fontSpec)) {
                        this.loadedFonts.add(fontName);
                        console.log(`✅ 字体 ${fontName} 加载成功`);
                        return true;
                    }
                    console.log(`❌ 字体 ${fontName} 加载失败`);
                    return false;
                } catch (error) {
                    console.log(`❌ 字体 ${fontName} 加载异常:`, error);
                    return false;
                }
            }
            
            getFontPriority() {
                return [FONT_CONFIG.primary, FONT_CONFIG.secondary, FONT_CONFIG.tertiary, FONT_CONFIG.quaternary];
            }
            
            async getCharacterScore(character, fontName) {
                console.log(`\n📊 开始计算字体 ${fontName} 对字符 '${character}' 的适配分数`);
                
                if (!await this.loadFont(fontName)) {
                    console.log(`❌ 字体 ${fontName} 未加载，返回分数 0`);
                    return 0;
                }
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                
                // 使用目标字体绘制字符
                ctx.clearRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 200, 200);
                ctx.font = `72px "${fontName}"`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'black';
                ctx.fillText(character, 100, 100);
                
                const targetImageData = ctx.getImageData(0, 0, 200, 200);
                
                // 使用默认字体绘制字符
                ctx.clearRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 200, 200);
                ctx.font = `72px serif`;
                ctx.fillStyle = 'black';
                ctx.fillText(character, 100, 100);
                
                const fallbackImageData = ctx.getImageData(0, 0, 200, 200);
                
                const targetData = targetImageData.data;
                const fallbackData = fallbackImageData.data;
                
                let differences = 0;
                let totalPixels = 0;
                
                for (let i = 0; i < targetData.length; i += 4) {
                    const targetAlpha = targetData[i + 3];
                    const fallbackAlpha = fallbackData[i + 3];
                    
                    if (targetAlpha > 0 || fallbackAlpha > 0) {
                        totalPixels++;
                        
                        const targetR = targetData[i];
                        const targetG = targetData[i + 1];
                        const targetB = targetData[i + 2];
                        
                        const fallbackR = fallbackData[i];
                        const fallbackG = fallbackData[i + 1];
                        const fallbackB = fallbackData[i + 2];
                        
                        const colorDiff = Math.abs(targetR - fallbackR) + 
                                        Math.abs(targetG - fallbackG) + 
                                        Math.abs(targetB - fallbackB) + 
                                        Math.abs(targetAlpha - fallbackAlpha);
                        
                        if (colorDiff > 10) {
                            differences++;
                        }
                    }
                }
                
                const score = totalPixels > 0 ? (differences / totalPixels) * 100 : 0;
                console.log(`📈 像素分析结果: 总像素=${totalPixels}, 差异像素=${differences}, 分数=${score.toFixed(2)}%`);
                
                return score;
            }
            
            async getAvailableFontForCharacter(character) {
                const fonts = this.getFontPriority();
                
                console.log(`\n=== 开始为字符 '${character}' 检测字体 ===`);
                console.log('🎯 字体优先级顺序:', fonts);
                
                for (let i = 0; i < fonts.length; i++) {
                    const font = fonts[i];
                    console.log(`\n🔍 检测字体 ${i + 1}/${fonts.length}: ${font}`);
                    
                    const fontLoaded = await this.loadFont(font);
                    console.log(`字体 ${font} 加载状态:`, fontLoaded);
                    
                    if (!fontLoaded) {
                        console.log(`⏭️ 字体 ${font} 加载失败，跳过`);
                        continue;
                    }
                    
                    const score = await this.getCharacterScore(character, font);
                    console.log(`🎯 字体 ${font} 对字符 '${character}' 的适配分数: ${score.toFixed(2)}%`);
                    
                    const threshold = 5;
                    
                    if (score > threshold) {
                        console.log(`✅ 选择字体: ${font} (分数: ${score.toFixed(2)}%)`);
                        console.log(`=== 字体检测完成 ===\n`);
                        return font;
                    } else {
                        console.log(`❌ 字体 ${font} 分数过低 (${score.toFixed(2)}%)，继续检测下一个字体`);
                    }
                }
                
                console.log(`\n⚠️ 所有甲骨文字体都不适合字符 '${character}'，使用默认字体 serif`);
                console.log(`=== 字体检测完成 ===\n`);
                return 'serif';
            }
        }
        
        async function testFontDetection() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔄 正在测试字体检测...';
            
            console.clear();
            console.log('🚀 开始测试"手"字字体检测');
            
            const fontLoader = new FontLoader();
            const result = await fontLoader.getAvailableFontForCharacter('手');
            
            resultDiv.innerHTML = `
                <strong>🎯 检测结果：</strong><br>
                "手"字应使用字体：<span style="color: red; font-weight: bold;">${result}</span><br>
                <small>详细检测过程请查看浏览器控制台</small>
            `;
            
            console.log('🏁 测试完成，结果:', result);
        }
        
        // 页面加载完成后自动测试
        window.addEventListener('load', () => {
            console.log('📄 页面加载完成，等待字体加载...');
            setTimeout(() => {
                console.log('⏰ 开始自动测试');
                testFontDetection();
            }, 1000);
        });
    </script>
</body>
</html>