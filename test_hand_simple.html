<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•æ‰‹å­—å­—ä½“</title>
    <style>
        @font-face {
            font-family: 'FangZhengOracle';
            src: url('fonts/FangZhengOracle.ttf') format('truetype');
        }
        @font-face {
            font-family: 'HYChenTiJiaGuWen';
            src: url('fonts/HYChenTiJiaGuWen.ttf') format('truetype');
        }
        @font-face {
            font-family: 'OeasyOracle';
            src: url('fonts/OeasyOracle.ttf') format('truetype');
        }
        @font-face {
            font-family: 'ZhongYanYuan';
            src: url('fonts/ZhongYanYuan.ttf') format('truetype');
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .char-display {
            font-size: 72px;
            margin: 10px;
            display: inline-block;
            border: 2px solid #ddd;
            padding: 20px;
            text-align: center;
            min-width: 120px;
        }
        
        .font-name {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        #result {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <h1>"æ‰‹"å­—å­—ä½“æµ‹è¯•</h1>
    
    <div class="test-container">
        <h3>å„å­—ä½“æ˜¾ç¤ºæ•ˆæœï¼š</h3>
        <div class="char-display" style="font-family: 'HYChenTiJiaGuWen', serif;">
            æ‰‹
            <div class="font-name">HYChenTiJiaGuWen</div>
        </div>
        <div class="char-display" style="font-family: 'OeasyOracle', serif;">
            æ‰‹
            <div class="font-name">OeasyOracle</div>
        </div>
        <div class="char-display" style="font-family: 'FangZhengOracle', serif;">
            æ‰‹
            <div class="font-name">FangZhengOracle</div>
        </div>
        <div class="char-display" style="font-family: 'ZhongYanYuan', serif;">
            æ‰‹
            <div class="font-name">ZhongYanYuan</div>
        </div>
        <div class="char-display" style="font-family: serif;">
            æ‰‹
            <div class="font-name">é»˜è®¤å­—ä½“ (serif)</div>
        </div>
    </div>
    
    <div class="test-container">
        <button onclick="testFontDetection()">æµ‹è¯•å­—ä½“æ£€æµ‹ç®—æ³•</button>
        <div id="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>
    
    <script>
        // å­—ä½“é…ç½®
        const FONT_CONFIG = {
            primary: 'HYChenTiJiaGuWen',
            secondary: 'OeasyOracle', 
            tertiary: 'FangZhengOracle',
            quaternary: 'ZhongYanYuan'
        };
        
        class FontLoader {
            constructor() {
                this.loadedFonts = new Set();
            }
            
            async loadFont(fontName) {
                try {
                    if (this.loadedFonts.has(fontName)) {
                        return true;
                    }
                    
                    await document.fonts.ready;
                    const fontSpec = `20px ${fontName}`;
                    if (document.fonts.check(fontSpec)) {
                        this.loadedFonts.add(fontName);
                        console.log(`âœ… å­—ä½“ ${fontName} åŠ è½½æˆåŠŸ`);
                        return true;
                    }
                    console.log(`âŒ å­—ä½“ ${fontName} åŠ è½½å¤±è´¥`);
                    return false;
                } catch (error) {
                    console.log(`âŒ å­—ä½“ ${fontName} åŠ è½½å¼‚å¸¸:`, error);
                    return false;
                }
            }
            
            getFontPriority() {
                return [FONT_CONFIG.primary, FONT_CONFIG.secondary, FONT_CONFIG.tertiary, FONT_CONFIG.quaternary];
            }
            
            async getCharacterScore(character, fontName) {
                console.log(`\nğŸ“Š å¼€å§‹è®¡ç®—å­—ä½“ ${fontName} å¯¹å­—ç¬¦ '${character}' çš„é€‚é…åˆ†æ•°`);
                
                if (!await this.loadFont(fontName)) {
                    console.log(`âŒ å­—ä½“ ${fontName} æœªåŠ è½½ï¼Œè¿”å›åˆ†æ•° 0`);
                    return 0;
                }
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                
                // ä½¿ç”¨ç›®æ ‡å­—ä½“ç»˜åˆ¶å­—ç¬¦
                ctx.clearRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 200, 200);
                ctx.font = `72px "${fontName}"`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'black';
                ctx.fillText(character, 100, 100);
                
                const targetImageData = ctx.getImageData(0, 0, 200, 200);
                
                // ä½¿ç”¨é»˜è®¤å­—ä½“ç»˜åˆ¶å­—ç¬¦
                ctx.clearRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 200, 200);
                ctx.font = `72px serif`;
                ctx.fillStyle = 'black';
                ctx.fillText(character, 100, 100);
                
                const fallbackImageData = ctx.getImageData(0, 0, 200, 200);
                
                const targetData = targetImageData.data;
                const fallbackData = fallbackImageData.data;
                
                let differences = 0;
                let totalPixels = 0;
                
                for (let i = 0; i < targetData.length; i += 4) {
                    const targetAlpha = targetData[i + 3];
                    const fallbackAlpha = fallbackData[i + 3];
                    
                    if (targetAlpha > 0 || fallbackAlpha > 0) {
                        totalPixels++;
                        
                        const targetR = targetData[i];
                        const targetG = targetData[i + 1];
                        const targetB = targetData[i + 2];
                        
                        const fallbackR = fallbackData[i];
                        const fallbackG = fallbackData[i + 1];
                        const fallbackB = fallbackData[i + 2];
                        
                        const colorDiff = Math.abs(targetR - fallbackR) + 
                                        Math.abs(targetG - fallbackG) + 
                                        Math.abs(targetB - fallbackB) + 
                                        Math.abs(targetAlpha - fallbackAlpha);
                        
                        if (colorDiff > 10) {
                            differences++;
                        }
                    }
                }
                
                const score = totalPixels > 0 ? (differences / totalPixels) * 100 : 0;
                console.log(`ğŸ“ˆ åƒç´ åˆ†æç»“æœ: æ€»åƒç´ =${totalPixels}, å·®å¼‚åƒç´ =${differences}, åˆ†æ•°=${score.toFixed(2)}%`);
                
                return score;
            }
            
            async getAvailableFontForCharacter(character) {
                const fonts = this.getFontPriority();
                
                console.log(`\n=== å¼€å§‹ä¸ºå­—ç¬¦ '${character}' æ£€æµ‹å­—ä½“ ===`);
                console.log('ğŸ¯ å­—ä½“ä¼˜å…ˆçº§é¡ºåº:', fonts);
                
                for (let i = 0; i < fonts.length; i++) {
                    const font = fonts[i];
                    console.log(`\nğŸ” æ£€æµ‹å­—ä½“ ${i + 1}/${fonts.length}: ${font}`);
                    
                    const fontLoaded = await this.loadFont(font);
                    console.log(`å­—ä½“ ${font} åŠ è½½çŠ¶æ€:`, fontLoaded);
                    
                    if (!fontLoaded) {
                        console.log(`â­ï¸ å­—ä½“ ${font} åŠ è½½å¤±è´¥ï¼Œè·³è¿‡`);
                        continue;
                    }
                    
                    const score = await this.getCharacterScore(character, font);
                    console.log(`ğŸ¯ å­—ä½“ ${font} å¯¹å­—ç¬¦ '${character}' çš„é€‚é…åˆ†æ•°: ${score.toFixed(2)}%`);
                    
                    const threshold = 5;
                    
                    if (score > threshold) {
                        console.log(`âœ… é€‰æ‹©å­—ä½“: ${font} (åˆ†æ•°: ${score.toFixed(2)}%)`);
                        console.log(`=== å­—ä½“æ£€æµ‹å®Œæˆ ===\n`);
                        return font;
                    } else {
                        console.log(`âŒ å­—ä½“ ${font} åˆ†æ•°è¿‡ä½ (${score.toFixed(2)}%)ï¼Œç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ªå­—ä½“`);
                    }
                }
                
                console.log(`\nâš ï¸ æ‰€æœ‰ç”²éª¨æ–‡å­—ä½“éƒ½ä¸é€‚åˆå­—ç¬¦ '${character}'ï¼Œä½¿ç”¨é»˜è®¤å­—ä½“ serif`);
                console.log(`=== å­—ä½“æ£€æµ‹å®Œæˆ ===\n`);
                return 'serif';
            }
        }
        
        async function testFontDetection() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•å­—ä½“æ£€æµ‹...';
            
            console.clear();
            console.log('ğŸš€ å¼€å§‹æµ‹è¯•"æ‰‹"å­—å­—ä½“æ£€æµ‹');
            
            const fontLoader = new FontLoader();
            const result = await fontLoader.getAvailableFontForCharacter('æ‰‹');
            
            resultDiv.innerHTML = `
                <strong>ğŸ¯ æ£€æµ‹ç»“æœï¼š</strong><br>
                "æ‰‹"å­—åº”ä½¿ç”¨å­—ä½“ï¼š<span style="color: red; font-weight: bold;">${result}</span><br>
                <small>è¯¦ç»†æ£€æµ‹è¿‡ç¨‹è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°</small>
            `;
            
            console.log('ğŸ æµ‹è¯•å®Œæˆï¼Œç»“æœ:', result);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…å­—ä½“åŠ è½½...');
            setTimeout(() => {
                console.log('â° å¼€å§‹è‡ªåŠ¨æµ‹è¯•');
                testFontDetection();
            }, 1000);
        });
    </script>
</body>
</html>