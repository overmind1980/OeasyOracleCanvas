<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uè声调变体测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .log {
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>uè声调变体发音测试</h1>
    
    <div class="test-section">
        <h2>uè四个声调测试</h2>
        <p>测试uè的四个声调变体，确保发音中不包含单独的u音：</p>
        <button class="test-button" onclick="testUeTone('ūè', '曰')">测试 ūè (曰)</button>
        <button class="test-button" onclick="testUeTone('úè', '跃')">测试 úè (跃)</button>
        <button class="test-button" onclick="testUeTone('ǔè', '月')">测试 ǔè (月)</button>
        <button class="test-button" onclick="testUeTone('ùè', '阅')">测试 ùè (阅)</button>
        <button class="test-button" onclick="testUeTone('uè', '越')">测试 uè (越)</button>
    </div>
    
    <div class="test-section">
        <h2>其他复合韵母测试</h2>
        <p>测试其他复合韵母的整体发音：</p>
        <button class="test-button" onclick="testCompoundVowel('ie', '夜')">测试 ie (夜)</button>
        <button class="test-button" onclick="testCompoundVowel('üe', '学')">测试 üe (学)</button>
        <button class="test-button" onclick="testCompoundVowel('īn', '音')">测试 īn (音)</button>
        <button class="test-button" onclick="testCompoundVowel('ín', '银')">测试 ín (银)</button>
        <button class="test-button" onclick="testCompoundVowel('ǐn', '引')">测试 ǐn (引)</button>
        <button class="test-button" onclick="testCompoundVowel('ìn', '印')">测试 ìn (印)</button>
    </div>
    
    <div class="test-section">
        <h2>测试结果</h2>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h2>调试日志</h2>
        <div class="log" id="log"></div>
    </div>

    <script>
        // 加载拼音映射配置
        let pinyinToCharacterMap = null;
        
        async function loadPinyinMap() {
            try {
                const response = await fetch('./pinyinToCharacterMap.json');
                if (!response.ok) {
                    throw new Error('无法加载拼音映射文件');
                }
                pinyinToCharacterMap = await response.json();
                window.pinyinToCharacterMap = pinyinToCharacterMap;
                log('✓ 拼音映射配置加载成功');
                return true;
            } catch (error) {
                log('✗ 拼音映射配置加载失败: ' + error.message);
                return false;
            }
        }
        
        // 日志函数
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // 拼音分解函数（与app.js保持一致）
        function decomposePinyin(pinyin, character = '') {
            log('=== 拼音分解函数 ===');
            log('输入拼音: ' + pinyin + ', 汉字: ' + character);
            
            let result = [];
            let originalPinyin = pinyin.toLowerCase();
            
            // 分解声母和韵母
            let shengmu = '';
            let yunmu = '';
            
            // 识别声母（按长度从长到短匹配）
            const shengmuList = ['zh', 'ch', 'sh', 'b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'r', 'z', 'c', 's', 'y', 'w'];
            
            for (let sm of shengmuList) {
                if (originalPinyin.startsWith(sm)) {
                    shengmu = sm;
                    yunmu = originalPinyin.substring(sm.length);
                    break;
                }
            }
            
            // 如果没有找到声母，整个就是韵母
            if (!shengmu) {
                yunmu = originalPinyin;
            }
            
            log('声母: ' + shengmu + ', 韵母: ' + yunmu);
            
            // 添加声母（辅音映射到汉字）
            if (shengmu) {
                const shengmuMapping = pinyinToCharacterMap["声母映射"][shengmu];
                if (shengmuMapping) {
                    result.push(shengmuMapping);
                    log('添加声母映射: ' + shengmu + ' → ' + shengmuMapping);
                } else {
                    result.push(shengmu);
                    log('未找到声母映射，使用原始: ' + shengmu);
                }
            }
            
            // 处理韵母（元音直接使用带声调拼音字母）
            if (yunmu) {
                // 特殊处理：某些复合韵母需要作为整体发音，不能分解
                const wholeVowels = ['uè', 'ūè', 'úè', 'ǔè', 'ùè', 'üe', 'ǖe', 'ǘe', 'ǚe', 'ǜe', 'ie', 'īe', 'íe', 'ǐe', 'ìe'];
                
                let processed = false;
                
                // 检查是否为需要整体发音的复合韵母
                for (let wholeVowel of wholeVowels) {
                    if (yunmu === wholeVowel) {
                        result.push(yunmu);
                        log('添加整体韵母（不分解）: ' + yunmu);
                        processed = true;
                        break;
                    }
                }
                
                // 如果不是特殊的整体韵母，检查是否需要分解
                if (!processed) {
                    // 处理其他复合韵母，如 "iǎo" -> "i" + "ǎo"
                    const singleVowels = ['i', 'u', 'ü', 'a', 'o', 'e'];
                    for (let vowel of singleVowels) {
                        if (yunmu.startsWith(vowel) && yunmu.length > 1) {
                            result.push(vowel);
                            log('添加第一个元音: ' + vowel);
                            
                            let remaining = yunmu.substring(vowel.length);
                            if (remaining) {
                                result.push(remaining);
                                log('添加剩余韵母: ' + remaining);
                            }
                            processed = true;
                            break;
                        }
                    }
                }
                
                // 如果都不匹配，直接添加整个韵母
                if (!processed) {
                    result.push(yunmu);
                    log('添加完整韵母: ' + yunmu);
                }
            }
            
            log('最终分解结果: ' + JSON.stringify(result));
            return result;
        }
        
        // 测试uè声调变体
        async function testUeTone(pinyin, character) {
            if (!pinyinToCharacterMap) {
                const loaded = await loadPinyinMap();
                if (!loaded) return;
            }
            
            log('\n=== 测试 ' + pinyin + ' (' + character + ') ===');
            
            // 分解拼音
            const decomposed = decomposePinyin(pinyin, character);
            
            // 显示结果
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = `
                <strong>${character} (${pinyin})</strong><br>
                分解结果: ${decomposed.join(' + ')}<br>
                <button onclick="speakSequence(['${decomposed.join("', '")}', '${character}'])">播放分解发音</button>
            `;
            resultsDiv.appendChild(resultDiv);
            
            // 自动播放
            speakSequence([...decomposed, character]);
        }
        
        // 测试其他复合韵母
        async function testCompoundVowel(pinyin, character) {
            if (!pinyinToCharacterMap) {
                const loaded = await loadPinyinMap();
                if (!loaded) return;
            }
            
            log('\n=== 测试 ' + pinyin + ' (' + character + ') ===');
            
            // 分解拼音
            const decomposed = decomposePinyin(pinyin, character);
            
            // 显示结果
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = `
                <strong>${character} (${pinyin})</strong><br>
                分解结果: ${decomposed.join(' + ')}<br>
                <button onclick="speakSequence(['${decomposed.join("', '")}', '${character}'])">播放分解发音</button>
            `;
            resultsDiv.appendChild(resultDiv);
            
            // 自动播放
            speakSequence([...decomposed, character]);
        }
        
        // 播放发音序列
        async function speakSequence(sequence) {
            log('播放发音序列: ' + JSON.stringify(sequence));
            
            speechSynthesis.cancel();
            
            for (let i = 0; i < sequence.length; i++) {
                await new Promise(resolve => {
                    const utterance = new SpeechSynthesisUtterance(sequence[i]);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.6;
                    
                    // 使用统一的中文语音引擎
                    const voices = speechSynthesis.getVoices();
                    const chineseVoices = voices.filter(voice => voice.lang.startsWith('zh'));
                    if (chineseVoices.length > 0) {
                        utterance.voice = chineseVoices[0];
                    }
                    
                    utterance.onend = resolve;
                    utterance.onerror = resolve;
                    
                    log('发音: ' + sequence[i]);
                    speechSynthesis.speak(utterance);
                });
                
                // 添加间隔
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            log('发音序列完成');
        }
        
        // 页面加载时初始化
        window.addEventListener('load', async () => {
            log('页面加载完成，初始化拼音映射...');
            await loadPinyinMap();
            
            // 等待语音引擎准备
            if ('speechSynthesis' in window) {
                speechSynthesis.getVoices();
                speechSynthesis.addEventListener('voiceschanged', () => {
                    log('语音引擎准备完成');
                });
            }
        });
    </script>
</body>
</html>