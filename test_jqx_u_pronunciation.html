<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>j/q/x+u发音规则测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-char {
            display: inline-block;
            margin: 10px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .test-char:hover {
            background: #bbdefb;
            transform: scale(1.05);
        }
        .pinyin {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>j/q/x+u发音规则测试</h1>
    
    <div class="test-container">
        <h2>测试汉字（点击测试拼音分解）</h2>
        <div class="test-char" onclick="testPronunciation('去', 'qù')">
            去<div class="pinyin">qù</div>
        </div>
        <div class="test-char" onclick="testPronunciation('取', 'qǔ')">
            取<div class="pinyin">qǔ</div>
        </div>
        <div class="test-char" onclick="testPronunciation('曲', 'qū')">
            曲<div class="pinyin">qū</div>
        </div>
        <div class="test-char" onclick="testPronunciation('趣', 'qù')">
            趣<div class="pinyin">qù</div>
        </div>
        <div class="test-char" onclick="testPronunciation('举', 'jǔ')">
            举<div class="pinyin">jǔ</div>
        </div>
        <div class="test-char" onclick="testPronunciation('句', 'jù')">
            句<div class="pinyin">jù</div>
        </div>
        <div class="test-char" onclick="testPronunciation('许', 'xǔ')">
            许<div class="pinyin">xǔ</div>
        </div>
        <div class="test-char" onclick="testPronunciation('续', 'xù')">
            续<div class="pinyin">xù</div>
        </div>
    </div>
    
    <div class="test-container">
        <h2>测试日志</h2>
        <div id="testLog" class="log"></div>
    </div>

    <script>
        // 全局变量
        let pinyinToCharacterMap = {};
        
        function log(message) {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 拼音分解函数（简化版，专门用于测试j/q/x+u规则）
        function decomposePinyin(pinyin, character = '') {
            console.log('=== 拼音分解函数测试版 ===');
            console.log('输入拼音:', pinyin, '汉字:', character);
            
            let result = [];
            let originalPinyin = pinyin.toLowerCase();
            
            // 分解声母和韵母
            let shengmu = '';
            let yunmu = '';
            
            // 识别声母
            const shengmuList = ['zh', 'ch', 'sh', 'b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'r', 'z', 'c', 's', 'y', 'w'];
            
            for (let sm of shengmuList) {
                if (originalPinyin.startsWith(sm)) {
                    shengmu = sm;
                    yunmu = originalPinyin.substring(sm.length);
                    break;
                }
            }
            
            if (!shengmu) {
                yunmu = originalPinyin;
            }
            
            console.log('声母:', shengmu, '韵母:', yunmu);
            
            // 添加声母映射
            if (shengmu) {
                const shengmuMapping = pinyinToCharacterMap['声母映射'] && pinyinToCharacterMap['声母映射'][shengmu];
                if (shengmuMapping) {
                    result.push(shengmuMapping);
                    console.log('添加声母映射:', shengmu, '→', shengmuMapping);
                } else {
                    result.push(shengmu);
                }
            }

            // 处理j/q/x+u的特殊规则
            if (['j', 'q', 'x'].includes(shengmu) && yunmu.startsWith('u')) {
                console.log('检测到j/q/x+u组合，将u转换为ü音');
                const uToUMap = {
                    'u': 'ü',
                    'ū': 'ǖ', 
                    'ú': 'ǘ',
                    'ǔ': 'ǚ',
                    'ù': 'ǜ'
                };
                
                for (let [uTone, umlautTone] of Object.entries(uToUMap)) {
                    if (yunmu.startsWith(uTone)) {
                        yunmu = yunmu.replace(uTone, umlautTone);
                        console.log('韵母转换:', yunmu);
                        break;
                    }
                }
            }
            
            // 处理韵母
            if (yunmu) {
                const yunmuMapping = pinyinToCharacterMap['韵母映射'] && pinyinToCharacterMap['韵母映射'][yunmu];
                if (yunmuMapping) {
                    result.push(yunmuMapping);
                    console.log('添加韵母映射:', yunmu, '→', yunmuMapping);
                } else {
                    result.push(yunmu);
                }
            }
            
            console.log('最终分解结果:', result);
            return result;
        }

        function testPronunciation(character, pinyin) {
            log(`\n=== 测试汉字: ${character} (${pinyin}) ===`);
            
            const decomposition = decomposePinyin(pinyin, character);
            log(`拼音分解结果: ${JSON.stringify(decomposition)}`);
            
            // 测试预期结果
            if (character === '去') {
                const expected = ['七', '育'];
                const isCorrect = JSON.stringify(decomposition) === JSON.stringify(expected);
                log(`预期结果: ${JSON.stringify(expected)}`);
                log(`测试结果: ${isCorrect ? '✅ 通过' : '❌ 失败'}`);
            }
            
            // 简单的语音测试
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(decomposition.join(' '));
                utterance.lang = 'zh-CN';
                speechSynthesis.speak(utterance);
                log(`🔊 播放分解发音: ${decomposition.join(' ')}`);
            }
        }

        // 加载拼音映射数据
        async function loadPinyinMapping() {
            try {
                const response = await fetch('pinyinToCharacterMap.json');
                pinyinToCharacterMap = await response.json();
                log('✅ 拼音映射数据加载成功');
                return pinyinToCharacterMap;
            } catch (error) {
                log(`❌ 拼音映射数据加载失败: ${error.message}`);
                throw error;
            }
        }

        // 页面加载完成后的初始化
        window.onload = async function() {
            log('页面加载完成，开始测试j/q/x+u发音规则');
            
            try {
                await loadPinyinMapping();
                log('✅ 初始化完成，可以开始测试');
                
                // 自动测试"去"字
                setTimeout(() => {
                    testPronunciation('去', 'qù');
                }, 500);
            } catch (error) {
                log(`❌ 初始化失败: ${error.message}`);
            }
        };
    </script>
</body>
</html>