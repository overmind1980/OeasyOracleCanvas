<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拼音分解声调测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #007cba;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #005a8b;
        }
    </style>
</head>
<body>
    <h1>拼音分解声调测试</h1>
    <p>测试拼音分解函数是否能正确使用带声调的韵母映射</p>
    
    <div class="test-section">
        <h2>测试用例</h2>
        <button onclick="testDecomposition('mā', '妈')">测试 mā (妈)</button>
        <button onclick="testDecomposition('má', '麻')">测试 má (麻)</button>
        <button onclick="testDecomposition('mǎ', '马')">测试 mǎ (马)</button>
        <button onclick="testDecomposition('mà', '骂')">测试 mà (骂)</button>
        <button onclick="testDecomposition('hǎi', '海')">测试 hǎi (海)</button>
        <button onclick="testDecomposition('ài', '爱')">测试 ài (爱)</button>
        <button onclick="testDecomposition('yǒu', '有')">测试 yǒu (有)</button>
        <button onclick="testDecomposition('yè', '夜')">测试 yè (夜)</button>
    </div>
    
    <div class="test-section">
        <h2>测试结果</h2>
        <div id="results"></div>
    </div>
    
    <script>
        let pinyinToCharacterMap = {};
        
        // 加载拼音映射配置
        async function loadPinyinMapping() {
            try {
                const response = await fetch('./pinyinToCharacterMap.json');
                if (response.ok) {
                    const config = await response.json();
                    console.log('成功加载拼音映射配置:', config);
                    
                    // 合并声母和韵母映射
                    pinyinToCharacterMap = {
                        ...config['声母映射'],
                        ...config['韵母映射']
                    };
                    console.log('加载的映射表:', pinyinToCharacterMap);
                } else {
                    console.error('无法加载拼音映射配置文件');
                }
            } catch (error) {
                console.error('加载拼音映射配置出错:', error);
            }
        }
        
        // 拼音分解函数（简化版，用于测试）
        function decomposePinyin(pinyin, character = '') {
            console.log('=== 拼音分解函数 ===');
            console.log('输入拼音:', pinyin, '汉字:', character);
            
            let result = [];
            let originalPinyin = pinyin.toLowerCase();
            
            // 分解声母和韵母
            let shengmu = '';
            let yunmu = '';
            
            // 识别声母（按长度从长到短匹配）
            const shengmuList = ['zh', 'ch', 'sh', 'b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'r', 'z', 'c', 's', 'y', 'w'];
            
            for (let sm of shengmuList) {
                if (originalPinyin.startsWith(sm)) {
                    shengmu = sm;
                    yunmu = originalPinyin.substring(sm.length);
                    break;
                }
            }
            
            // 如果没有找到声母，整个就是韵母
            if (!shengmu) {
                yunmu = originalPinyin;
            }
            
            console.log('分解结果 - 声母:', shengmu, '韵母:', yunmu);
            
            // 添加对应的汉字发音
            if (shengmu && pinyinToCharacterMap[shengmu]) {
                result.push(pinyinToCharacterMap[shengmu]);
                console.log('声母映射:', shengmu, '→', pinyinToCharacterMap[shengmu]);
            }
            
            // 处理韵母
            if (yunmu) {
                if (pinyinToCharacterMap[yunmu]) {
                    result.push(pinyinToCharacterMap[yunmu]);
                    console.log('韵母映射:', yunmu, '→', pinyinToCharacterMap[yunmu]);
                } else {
                    console.log('未找到韵母映射:', yunmu);
                }
            }
            
            console.log('最终分解结果:', result);
            return result;
        }
        
        // 测试拼音分解
        function testDecomposition(pinyin, character) {
            const decomposed = decomposePinyin(pinyin, character);
            
            const resultsDiv = document.getElementById('results');
            const resultElement = document.createElement('div');
            resultElement.className = 'result';
            resultElement.innerHTML = `
                <h3>${character} (${pinyin})</h3>
                <p><strong>分解结果：</strong>${decomposed.join(' + ')}</p>
                <button onclick="speakDecomposition(['${decomposed.join("', '")}', '${character}'])">播放分解朗读</button>
            `;
            
            resultsDiv.appendChild(resultElement);
        }
        
        // 播放分解朗读
        async function speakDecomposition(parts) {
            if (!('speechSynthesis' in window)) {
                alert('浏览器不支持语音合成');
                return;
            }
            
            speechSynthesis.cancel();
            
            for (let i = 0; i < parts.length; i++) {
                await new Promise(resolve => {
                    const utterance = new SpeechSynthesisUtterance(parts[i]);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.8;
                    utterance.onend = resolve;
                    speechSynthesis.speak(utterance);
                });
                
                // 500ms间隔
                if (i < parts.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
        }
        
        // 页面加载时初始化
        window.addEventListener('load', async () => {
            await loadPinyinMapping();
            console.log('页面加载完成，映射表已加载');
        });
    </script>
</body>
</html>