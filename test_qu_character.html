<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试"去"字拼音分解</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .test-char {
            font-size: 80px;
            color: #2c3e50;
            margin: 20px;
            cursor: pointer;
            padding: 20px;
            border: 3px solid #3498db;
            border-radius: 15px;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .test-char:hover {
            background-color: #3498db;
            color: white;
            transform: scale(1.05);
        }
        .pinyin {
            font-size: 24px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .expected-sequence {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>测试"去"字拼音分解</h1>
        <div class="expected-sequence">
            <strong>期望的朗读序列：七 → 育 → 去（qù四声）</strong>
        </div>
        
        <div class="test-char" onclick="testQuCharacter()">
            去
            <div class="pinyin">qù</div>
        </div>
        
        <p>点击"去"字测试拼音分解朗读</p>
        
        <div class="log-container" id="logContainer">
            <div>等待测试...</div>
        </div>
    </div>

    <script>
        // 加载拼音映射配置
        let pinyinToCharacterMap = {};
        
        // 从主应用加载配置
        fetch('./pinyinToCharacterMap.json')
            .then(response => response.json())
            .then(data => {
                // 合并声母和韵母映射
                pinyinToCharacterMap = {...data['声母映射'], ...data['韵母映射']};
                log('✓ 拼音映射配置加载成功');
                log('q映射到: ' + pinyinToCharacterMap['q']);
                log('ù映射到: ' + pinyinToCharacterMap['ù']);
            })
            .catch(error => {
                log('✗ 拼音映射配置加载失败: ' + error);
            });
        
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 拼音分解函数（简化版）
        function decomposePinyin(pinyin, character = '') {
            log('=== 开始拼音分解 ===');
            log('输入拼音: ' + pinyin + ', 汉字: ' + character);
            
            let result = [];
            let originalPinyin = pinyin.toLowerCase();
            
            // 分解声母和韵母
            let shengmu = '';
            let yunmu = '';
            
            // 识别声母
            const shengmuList = ['zh', 'ch', 'sh', 'b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'r', 'z', 'c', 's', 'y', 'w'];
            
            for (let sm of shengmuList) {
                if (originalPinyin.startsWith(sm)) {
                    shengmu = sm;
                    yunmu = originalPinyin.substring(sm.length);
                    break;
                }
            }
            
            if (!shengmu) {
                yunmu = originalPinyin;
            }
            
            log('声母: ' + shengmu + ', 韵母: ' + yunmu);
            
            // 添加声母映射
            if (shengmu) {
                const shengmuMapping = pinyinToCharacterMap[shengmu];
                if (shengmuMapping) {
                    result.push(shengmuMapping);
                    log('声母映射: ' + shengmu + ' → ' + shengmuMapping);
                } else {
                    result.push(shengmu);
                    log('未找到声母映射，使用原始: ' + shengmu);
                }
            }
            
            // 处理j/q/x+u的特殊规则
            if (['j', 'q', 'x'].includes(shengmu) && yunmu.startsWith('u')) {
                log('检测到j/q/x+u组合，将u转换为ü音');
                const uToUMap = {
                    'u': 'ü',
                    'ū': 'ǖ', 
                    'ú': 'ǘ',
                    'ǔ': 'ǚ',
                    'ù': 'ǜ'
                };
                
                for (let [uTone, umlautTone] of Object.entries(uToUMap)) {
                    if (yunmu.startsWith(uTone)) {
                        yunmu = yunmu.replace(uTone, umlautTone);
                        log('韵母转换: ' + uTone + ' → ' + umlautTone);
                        break;
                    }
                }
            }
            
            // 添加韵母映射
            if (yunmu) {
                const yunmuMapping = pinyinToCharacterMap[yunmu];
                if (yunmuMapping) {
                    result.push(yunmuMapping);
                    log('韵母映射: ' + yunmu + ' → ' + yunmuMapping);
                } else {
                    result.push(yunmu);
                    log('未找到韵母映射，使用原始: ' + yunmu);
                }
            }
            
            log('分解结果: [' + result.join(', ') + ']');
            return result;
        }
        
        // 测试"去"字
        function testQuCharacter() {
            log('\n=== 测试"去"字拼音分解 ===');
            
            const character = '去';
            const pinyin = 'qù';
            
            // 分解拼音
            const decomposed = decomposePinyin(pinyin, character);
            
            // 创建完整朗读序列
            const sequence = [...decomposed, character];
            log('完整朗读序列: [' + sequence.join(' → ') + ']');
            
            // 验证期望结果
            const expected = ['七', '育', '去'];
            const isCorrect = JSON.stringify(sequence) === JSON.stringify(expected);
            
            if (isCorrect) {
                log('✅ 测试通过！朗读序列正确: ' + sequence.join(' → '));
            } else {
                log('❌ 测试失败！');
                log('期望序列: [' + expected.join(' → ') + ']');
                log('实际序列: [' + sequence.join(' → ') + ']');
            }
            
            // 开始朗读测试
            log('\n=== 开始朗读测试 ===');
            speakSequence(sequence);
        }
        
        // 朗读序列
        function speakSequence(sequence) {
            let currentIndex = 0;
            
            function speakNext() {
                if (currentIndex >= sequence.length) {
                    log('✅ 朗读序列完成');
                    return;
                }
                
                const textToSpeak = sequence[currentIndex];
                log('正在朗读: ' + textToSpeak + ' (' + (currentIndex + 1) + '/' + sequence.length + ')');
                
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.4;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                utterance.onstart = () => {
                    log('▶ 开始朗读: ' + textToSpeak);
                };
                
                utterance.onend = () => {
                    log('✓ 朗读完成: ' + textToSpeak);
                    currentIndex++;
                    setTimeout(speakNext, 500);
                };
                
                utterance.onerror = (event) => {
                    log('✗ 朗读出错: ' + textToSpeak + ' - ' + event.error);
                    currentIndex++;
                    setTimeout(speakNext, 500);
                };
                
                speechSynthesis.speak(utterance);
            }
            
            // 确保语音合成停止
            speechSynthesis.cancel();
            setTimeout(speakNext, 200);
        }
        
        // 页面加载完成后的初始化
        window.addEventListener('load', () => {
            log('页面加载完成，准备测试"去"字拼音分解');
            log('期望结果：七 → 育 → 去（qù四声）');
        });
    </script>
</body>
</html>